# PLAN: 07-01 - Hand Evaluation & Settlement

Goal: Implement Texas Holdâ€™em hand evaluation, winner determination, pot settlement, and bankroll persistence exactly per the source-of-truth spec in `.planning/research/holdem-hand-eval.md`.

## User Review Required

> [!IMPORTANT]
> - This plan replaces the current `pokersolver` dependency with a custom implementation to match the project's specific requirements for tie-breaking and description formats.
> - Persistence will move from simple session-based to `localStorage` for bankrolls, allowing long-term tracking.

## Proposed Changes

### 1. Evaluator Module (`src/lib/poker/evaluator.ts`)
- Replace `pokersolver` usage with a custom `evaluate7(cards)` function.
- Implement feature extraction: `countsByRank`, `cardsBySuit`, `uniqueRanks`.
- Implement ranking logic for all 9 hand classes (Straight Flush to High Card).
- Support Ace-low straight (wheel).
- Implement lexicographical comparison using `handValue` tuple.
- Add `determineWinners(players, board)` to identify winning player IDs and handle ties.

### 2. Settlement Module (`src/lib/poker/settlement.ts`)
- Implement `settlePot(players, pot, dealerIndex)` function.
- Handle even splitting of pots among winners.
- Implement the "remainder chip rule" (award remainder to earliest seat left of dealer).
- Calculate final bankroll updates.

### 3. Persistence & Bankroll Store (`src/lib/poker/bankroll.ts`)
- Implement `loadBankrolls()` and `saveBankrolls()` using `localStorage` key `gto_teacher.bankrolls.v1`.
- Integrate bankroll updates into the game loop after each hand settlement.
- Update `GameState` to include persistent bankroll information.

### 4. UI: Hand Guide Toggle (`src/components/poker/HandGuide.tsx`)
- Create a side toggle panel for the Hand Guide.
- Display hand ranking templates as specified in the spec.
- At showdown, show the evaluated hand (class, best 5 cards, description) for each player.

### 5. Documentation
- Update `REQUIREMENTS.md` to link to `research/holdem-hand-eval.md`.

## Verification Plan

### Automated Tests
- Create `src/lib/poker/__tests__/evaluator.test.ts` covering:
  - Straight flush vs. Four of a kind.
  - Full house from two trips.
  - Three pairs (choosing top two).
  - Wheel straight (A-2-3-4-5).
  - Board-only tie.
  - Two pair kicker comparison.
  - Flush high-card comparison across suits.
  - Sample case: board `8S 4S 8C 3S JS`, P1 `Jd 6d` vs P2 `3h 5c`.
- Create `src/lib/poker/__tests__/settlement.test.ts`:
  - Split pot even distribution.
  - Remainder chip distribution by seat order.

### Manual Verification
- Start a game and play until showdown.
- Verify "Hand Guide" shows correct templates.
- Confirm winning hand description matches the spec (e.g., "Full house, Kings full of Aces").
- Verify bankroll persists after refreshing the page.
