---
phase: 10-table-positions-advanced-analysis-rotation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/poker/types.ts, src/lib/poker/state-machine.ts, src/lib/poker/__tests__/engine.test.ts, src/components/poker/GameController.tsx]
autonomous: true
requirements: [PH10-POSITIONS, PH10-ROTATION]
---

<objective>
Implement formal table position mapping (BTN, SB, BB, UTG, HJ, CO) for 2-6 players and hand-over-hand rotation in the engine.

Purpose: To provide a professional poker experience with correct blind and action order mapping across different table sizes.
Output: Updated PokerGame engine with rotation logic and unit tests confirming 2, 3, and 6 player positions.
</objective>

<execution_context>
@C:/Users/sinha/.gemini/get-shit-done/workflows/execute-plan.md
@C:/Users/sinha/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-table-positions-advanced-analysis-rotation/10-CONTEXT.md
@src/lib/poker/types.ts
@src/lib/poker/state-machine.ts
@src/lib/poker/__tests__/engine.test.ts
@src/components/poker/GameController.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Types and Position Mapping Logic</name>
  <files>src/lib/poker/types.ts, src/lib/poker/state-machine.ts</files>
  <action>
    - Add `Position` type to `types.ts`: `type Position = 'BTN' | 'SB' | 'BB' | 'UTG' | 'HJ' | 'CO';`.
    - Add `position?: Position` to `Player` interface in `types.ts`.
    - In `state-machine.ts`, implement a helper method `getPositionMapping(dealerIndex: number, numPlayers: number): Record<number, Position>`.
    - Mapping rules:
      - n=2: BTN/SB (dealerIndex), BB ((dealerIndex+1)%n)
      - n=3: BTN (dealer), SB (dealer+1), BB (dealer+2)
      - n=4: BTN (dealer), SB (dealer+1), BB (dealer+2), CO (dealer+3)
      - n=5: BTN (dealer), SB (dealer+1), BB (dealer+2), HJ (dealer+3), CO (dealer+4)
      - n=6: BTN (dealer), SB (dealer+1), BB (dealer+2), UTG (dealer+3), HJ (dealer+4), CO (dealer+5)
    - Update `initializeGame` to use this mapping and set player positions.
    - Ensure `firstActorIndex` logic aligns with positions (UTG preflop, SB postflop).
  </action>
  <verify>
    <automated>npm test src/lib/poker/__tests__/engine.test.ts</automated>
    <manual>Check logs in DebugPanel for correct position assignment.</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>Positions are correctly assigned to players based on dealerIndex for 2-6 player tables.</done>
</task>

<task type="auto">
  <name>Task 2: Unit Tests for 2-6 Player Positions & Rotation</name>
  <files>src/lib/poker/__tests__/engine.test.ts</files>
  <action>
    - Add tests to `engine.test.ts` to verify position mapping and initial actor for 2, 3, and 6 players.
    - Verify rotation logic by simulating two consecutive `initializeGame` calls with incremented `dealerIndex`.
  </action>
  <verify>
    <automated>npm test src/lib/poker/__tests__/engine.test.ts</automated>
  </verify>
  <done>Unit tests pass for all player counts and rotation logic.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Hand Rotation in GameController</name>
  <files>src/components/poker/GameController.tsx</files>
  <action>
    - Update `startHand` to accept an optional `dealerIndex`.
    - Modify `onNextHand` in `ActionBar` (called via `GameController`) to increment the `dealerIndex` based on current `gameState.dealerIndex` and `playerCount`.
    - Rotation logic: `(currentDealerIndex + 1) % playerCount`.
    - Ensure the first hand of a session starts with a random or fixed dealerIndex (e.g., 0).
  </action>
  <verify>
    <automated>npm test src/lib/poker/__tests__/engine.test.ts</automated>
    <manual>Play 2-3 hands in the browser; verify the "D" button moves clockwise.</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>Dealer button rotates to the next player after each hand completes.</done>
</task>

</tasks>

<verification>
- Positions BTN, SB, BB, UTG, HJ, CO are correctly assigned.
- Dealer rotates clockwise each hand.
- Action order is correct (UTG first preflop, SB first postflop).
</verification>

<success_criteria>
- Positions mapping matches the requirements.
- Rotation works for 2-6 players.
- Tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/10-table-positions-advanced-analysis-rotation/10-01-SUMMARY.md`
</output>
