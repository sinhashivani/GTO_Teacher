# PLAN: 09-03 - Security Hardening & Stable Settings

Goal: Secure bot cards from client inspection and ensure settings changes are applied safely between hands.

## Proposed Changes

### 1. Engine: Leak Prevention (`src/lib/poker/state-machine.ts`)
- Implement a `getPublicState(playerId)` method that returns a `GameState` with other players' `holeCards` hidden (null/empty) unless `stage === 'SHOWDOWN'`.
- Ensure `BotAI` still has access to the full internal state but the UI only receives the public state.

### 2. UI: Stable Settings (`src/components/poker/GameController.tsx`)
- Refactor how settings are consumed.
- Create a `pendingSettings` state that buffers changes to Difficulty and Player Count.
- Only apply `pendingSettings` during `startHand()`, preventing middle-of-hand re-renders from resetting the state machine.

### 3. Persistence: Structured Reporting (`src/lib/db.ts`)
- Update `HandHistory` schema to store the new structured coaching objects.
- Ensure old hands don't crash the UI (add migration/defaults).

## Verification Plan

### Automated Tests
- Create `src/lib/poker/__tests__/security.test.ts`:
  - Verify `getPublicState` masks hole cards correctly for different players.

### Manual Verification
- Change difficulty during a hand and verify the hand continues normally.
- Start a new hand and verify the difficulty change has then applied.
- Inspect the browser console/state and verify bot cards are not visible pre-showdown.
