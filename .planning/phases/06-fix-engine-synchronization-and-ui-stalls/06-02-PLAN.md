---
phase: 06-fix-engine-synchronization-and-ui-stalls
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/lib/poker/state-machine.ts, src/components/poker/GameController.tsx]
autonomous: true
requirements: [PH6-ENGINE]
must_haves:
  truths:
    - "Turn order is correct for 2, 3, and 6 players (Heads-up vs Multiplayer rules)"
    - "Bots act reliably even after street transitions"
    - "Race conditions in bot triggering are eliminated"
  artifacts:
    - path: "src/lib/poker/state-machine.ts"
      provides: "Harden turn logic"
    - path: "src/components/poker/GameController.tsx"
      provides: "Synchronized bot effect"
  key_links:
    - from: "GameController.tsx Bot useEffect"
      to: "isBotThinking state"
      via: "Cleanup and robust checks"
---

<objective>
Harden the poker engine's turn order logic and synchronize the Bot AI triggering with the new asynchronous street transitions. Ensure correct poker rules are followed for all supported player counts (2-6).
</objective>

<execution_context>
@C:/Users/sinha/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/06-fix-engine-synchronization-and-ui-stalls/06-01-SUMMARY.md
@src/lib/poker/state-machine.ts
@src/components/poker/GameController.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and Fix Turn Order Logic</name>
  <files>src/lib/poker/state-machine.ts</files>
  <action>
    1. Audit `initializeGame` in `state-machine.ts`:
       - Verify Heads-up (2 players): Dealer is SB, BB is Big Blind. Preflop Dealer acts first. Postflop BB acts first.
       - Verify Multiplayer (3+): Dealer is Button, SB is Dealer+1, BB is Dealer+2. Preflop UTG (Dealer+3) acts first. Postflop SB acts first.
    2. Audit `getPostFlopFirstActor`:
       - Ensure it correctly skips folded players and players with 0 chips (all-in).
       - Ensure it handles the case where the dealer might be the only one left.
    3. Implementation:
       - Fix the `firstActorIndex` calculation for exactly 3 players (currently Dealer+3 % 3 = Dealer, which is correct for UTG in 3-handed).
       - Ensure `smallBlind` and `bigBlind` are posted correctly for all counts.
  </action>
  <verify>
    <automated>npm test src/lib/poker/__tests__/engine.test.ts</automated>
    <manual>Launch game with 3 players. Verify that preflop, the Dealer acts first (UTG). Verify that postflop, the player to the left of the dealer acts first.</manual>
  </verify>
  <done>Turn order logic follows standard poker rules for 2-6 players.</done>
</task>

<task type="auto">
  <name>Task 2: Synchronize Bot AI and Hero-All-In Effects</name>
  <files>src/components/poker/GameController.tsx</files>
  <action>
    1. Refactor the Bot action `useEffect` in `GameController.tsx`:
       - Add a check for `activePlayerIndex !== -1`.
       - Ensure it does NOT fire if the game is in a transition state (from Plan 01).
       - Add more robust `isBotThinking` management: set it immediately when the turn is detected, and clear it only after the state update is confirmed.
    2. Refactor the Hero-All-In auto-check `useEffect`:
       - Ensure it also respects the transition state and syncs with the bot logic.
    3. Ensure that if a bot is the first to act on a new street, it triggers correctly after the street transition delay completes.
  </action>
  <verify>
    <automated>grep "isBotThinking" src/components/poker/GameController.tsx</automated>
    <manual>Test a scenario where you go all-in preflop. Verify the bot calls and the remaining streets are dealt automatically with proper pauses.</manual>
  </verify>
  <done>Bot actions and auto-checks trigger reliably and without race conditions.</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Final End-to-End Verification</name>
  <what-built>Complete async poker loop with correct turn order and bot logic.</what-built>
  <how-to-verify>
    1. Start a 3-player game.
    2. Observe preflop turn order (Dealer/UTG acts first).
    3. Call/Raise and observe the delay before Flop.
    4. Observe postflop turn order (SB acts first).
    5. Go all-in and ensure the engine completes the hand (Turn, River, Showdown) with 2-second pauses between each, showing bot actions clearly.
    6. Verify that "Victory/Defeat" appears correctly at the end.
  </how-to-verify>
  <resume-signal>approved</resume-signal>
</task>

</tasks>

<verification>
Run the existing engine tests and add a new test case for 3-player turn order.
Manually play 5 hands to ensure no "stalls" occur where the bot is active but not moving.
</verification>

<success_criteria>
- Bots never "stall" on their turn.
- The UI is never out of sync with the internal state machine.
- Turn order is correct for all player counts.
</success_criteria>

<output>
After completion, create `.planning/phases/06-fix-engine-synchronization-and-ui-stalls/06-02-SUMMARY.md`
</output>
