---
phase: 06-fix-engine-synchronization-and-ui-stalls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/poker/types.ts, src/components/poker/GameController.tsx, src/components/poker/PlayerSeat.tsx]
autonomous: true
requirements: [PH6-TRANSITION]
must_haves:
  truths:
    - "UI shows the final action of a round (e.g. 'Call') before dealing next cards"
    - "Street transitions occur with a visible delay"
    - "No synchronous while loop exists in processAction"
  artifacts:
    - path: "src/lib/poker/types.ts"
      provides: "lastAction field in GameState"
    - path: "src/components/poker/GameController.tsx"
      provides: "Asynchronous street transition logic"
  key_links:
    - from: "GameController.tsx processAction"
      to: "GameState"
      via: "setGameState with immediate action result"
    - from: "GameController.tsx useEffect"
      to: "pokerEngine.transitionToFlop/Turn/River"
      via: "setTimeout when activePlayerIndex is -1"
---

<objective>
Refactor the poker engine street transitions from synchronous to asynchronous. This ensures that the UI has time to render the results of the final action in a betting round (like a bot's 'Call') before the cards for the next street are dealt.
</objective>

<execution_context>
@C:/Users/sinha/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/debug/engine-ui-stall.md
@src/lib/poker/types.ts
@src/components/poker/GameController.tsx
@src/components/poker/PlayerSeat.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lastAction tracking and refactor processAction</name>
  <files>src/lib/poker/types.ts, src/components/poker/GameController.tsx</files>
  <action>
    1. Update `GameState` interface in `src/lib/poker/types.ts` to ensure `lastAction` is properly supported (it already exists but we need to ensure it's populated).
    2. In `GameController.tsx`, modify `processAction`:
       - Remove the `while (newState.activePlayerIndex === -1 ...)` loop entirely.
       - Ensure `newState` returned by `handleAction` is set directly to state.
       - Add logic to store the `lastAction` in the state update so the UI knows what just happened.
       - If `newState.stage` becomes "SHOWDOWN" via `handleAction` (e.g. someone folds), handle the DB persistence as before.
  </action>
  <verify>
    <automated>grep -v "while.*activePlayerIndex" src/components/poker/GameController.tsx</automated>
    <manual>Verify that the game stops after a round-closing action and doesn't deal new cards immediately.</manual>
  </verify>
  <done>Synchronous transitions are removed and the UI reflects the single action state.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Async Transition Effect</name>
  <files>src/components/poker/GameController.tsx</files>
  <action>
    1. Implement a new `useEffect` in `GameController.tsx` that monitors `gameState`.
    2. Trigger: `gameState?.activePlayerIndex === -1` AND `gameState?.stage !== "SHOWDOWN"`.
    3. Action:
       - Use a `setTimeout` (1500-2000ms).
       - Inside timeout, call `pokerEngine.transitionToFlop/Turn/River` based on current stage.
       - Update `gameState` with the result.
    4. Ensure cleanup of timeout to prevent memory leaks or duplicate transitions.
    5. Handle the edge case where all players are all-in (skip multiple streets) by recursively or sequentially triggering transitions.
  </action>
  <verify>
    <automated>grep "setTimeout" src/components/poker/GameController.tsx | grep "transitionTo"</automated>
    <manual>Play a hand to the flop; verify cards appear after a 2-second pause following the preflop call.</manual>
  </verify>
  <done>Street transitions happen asynchronously with a visible delay.</done>
</task>

<task type="auto">
  <name>Task 3: Display Last Action in PlayerSeat</name>
  <files>src/components/poker/PlayerSeat.tsx, src/components/poker/GameController.tsx</files>
  <action>
    1. Update `PlayerSeatProps` to include an optional `lastAction` string.
    2. In `PlayerSeat.tsx`, add a visual indicator (e.g., a badge or text overlay) that shows the player's last action if it exists.
    3. In `GameController.tsx`, pass the `gameState.lastAction` to the corresponding `PlayerSeat` component.
    4. Logic: Only show the action if it belongs to that player and occurred in the current or most recent state.
  </action>
  <verify>
    <automated>grep "lastAction" src/components/poker/PlayerSeat.tsx</automated>
    <manual>Verify that 'Call', 'Check', or 'Raise' appears above the player's seat after they move.</manual>
  </verify>
  <done>UI clearly communicates the last action during street transitions.</done>
</task>

</tasks>

<verification>
Start a game with 2 players. Place a bet as Hero. Let the bot call.
Check that the bot seat shows "CALL" for ~2 seconds.
Check that the community cards are dealt ONLY after the delay.
Check that the "CALL" text disappears or updates when the next round starts.
</verification>

<success_criteria>
- No more stalls where the round doesn't progress.
- Transitions are smooth and visually understandable.
- The root cause identified in engine-ui-stall.md (sync transitions) is eliminated.
</success_criteria>

<output>
After completion, create `.planning/phases/06-fix-engine-synchronization-and-ui-stalls/06-01-SUMMARY.md`
</output>
