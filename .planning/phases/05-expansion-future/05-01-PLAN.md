---
phase: 05-expansion-future
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/poker/types.ts, src/lib/poker/state-machine.ts, src/lib/poker/betting.ts, src/lib/poker/evaluator.ts]
autonomous: true
requirements: [PH5-STREETS, PH5-MULTIPLAYER, PH5-SIDEPOTS]

must_haves:
  truths:
    - "Engine supports up to 6 players with correct turn order"
    - "Game transitions correctly through Turn and River to Showdown"
    - "Side pots are calculated for multiple all-ins"
  artifacts:
    - path: "src/lib/poker/types.ts"
      provides: "Expanded game state and stage types"
    - path: "src/lib/poker/betting.ts"
      provides: "Side pot calculation logic"
  key_links:
    - from: "src/lib/poker/state-machine.ts"
      to: "src/lib/poker/betting.ts"
      via: "pot calculation on transitions"
---

<objective>
Expand the core poker engine to support multiplayer (up to 6 seats), full streets (Turn/River), and side pot logic.

Purpose: Foundation for full-game expansion.
Output: Enhanced types, state machine, and betting logic.
</objective>

<execution_context>
@C:/Users/sinha/.gemini/get-shit-done/workflows/execute-plan.md
@C:/Users/sinha/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/poker/types.ts
@src/lib/poker/state-machine.ts
@src/lib/poker/betting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Types and Evaluator</name>
  <files>src/lib/poker/types.ts, src/lib/poker/evaluator.ts</files>
  <action>
    - Update `GameStage` enum/type to include `TURN`, `RIVER`, and `SHOWDOWN`.
    - Update `GameState` to support an array of `sidePots: { amount: number, participants: number[] }[]`.
    - Modify `src/lib/poker/evaluator.ts` to use `pokersolver` (already in package.json) to find the best 5-card hand from the 7 cards available at Showdown (2 hole + 5 community).
  </action>
  <verify>
    <automated>npm test src/lib/poker/__tests__/evaluator.test.ts</automated>
    <manual>None</manual>
    <sampling_rate>After task completion</sampling_rate>
  </verify>
  <done>Types support full streets and side pots; evaluator correctly identifies best hand from 7 cards.</done>
</task>

<task type="auto">
  <name>Task 2: Multi-player Turn Order and Side Pots</name>
  <files>src/lib/poker/state-machine.ts, src/lib/poker/betting.ts</files>
  <action>
    - Update `getNextPlayer` in `state-machine.ts` to handle 2-6 players.
    - Heads-up (2 players): Dealer is SB, acts first preflop, BB acts first post-flop.
    - Multiplayer (3+ players): SB is (D+1)%N, BB is (D+2)%N. UTG (first to act preflop) is (D+3)%N. Post-flop, first actor is the first non-folded player starting from the seat after the Dealer.
    - Implement `calculateSidePots` in `betting.ts` to handle cases where multiple players go all-in with different amounts.
    - Extend `transitionToNextStage` to handle `TURN` and `RIVER` dealing logic (1 card each).
  </action>
  <verify>
    <automated>npm test src/lib/poker/__tests__/engine.test.ts</automated>
    <manual>None</manual>
    <sampling_rate>After task completion</sampling_rate>
  </verify>
  <done>Turn order is correct for all player counts; side pots calculate correctly; streets transition through River.</done>
</task>

</tasks>

<verification>
Check that the state machine correctly deals 5 community cards in total and stops at Showdown. Verify that for 3 players, the Dealer is not the SB unless it's a heads-up game.
</verification>

<success_criteria>
- Engine handles 2-6 players without crashing.
- Side pots correctly distributed in multi-way all-in scenarios.
- Stage transitions from Preflop -> Flop -> Turn -> River -> Showdown function correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/05-expansion-future/05-01-SUMMARY.md`
</output>
