---
phase: 05-expansion-future
plan: 04
type: execute
wave: 4
depends_on: [05-03]
files_modified: [src/components/poker/TavernLobby.tsx, src/components/poker/SettingsDialog.tsx, src/components/poker/GameController.tsx, src/lib/db.ts]
autonomous: false
requirements: [PH5-PERSISTENCE, PH5-LEAVE]

must_haves:
  truths:
    - "Lobby allows selecting 2-6 players and difficulty"
    - "Settings changes during a hand do not reset the hand"
    - "Leaving a game prompts for confirmation and records a forfeit"
  artifacts:
    - path: "src/components/poker/TavernLobby.tsx"
      provides: "Table setup configuration"
    - path: "src/lib/db.ts"
      provides: "Persistence for table config and history"
  key_links:
    - from: "src/components/poker/GameController.tsx"
      to: "src/lib/db.ts"
      via: "saving forfeited hands"
---

<objective>
Implement Lobby configuration, settings persistence, and "Leave Game" functionality.

Purpose: User control over game setup and session lifecycle.
Output: Persistent table settings and forfeiture logic.
</objective>

<execution_context>
@C:/Users/sinha/.gemini/get-shit-done/workflows/execute-plan.md
@C:/Users/sinha/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/poker/TavernLobby.tsx
@src/components/poker/SettingsDialog.tsx
@src/lib/db.ts
@.planning/phases/05-expansion-future/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Table Setup and Persistent Settings</name>
  <files>src/components/poker/TavernLobby.tsx, src/components/poker/SettingsDialog.tsx, src/lib/db.ts</files>
  <action>
    - Add "Player Count" (2-6) and "Table Difficulty" (Easy, Medium, Expert, Mixed) options to `TavernLobby.tsx`.
    - Update `db.ts` to store `TableConfig` and `UserPreferences` in IndexedDB via Dexie.js.
    - Modify `SettingsDialog.tsx` to ensure coaching toggles (e.g., "Show Recommendations") only affect rendering and do not trigger a hand reset.
    - If a setting requires a reset, add a "Applies next hand" label and queue the change.
  </action>
  <verify>
    <automated>None</automated>
    <manual>Change settings, refresh page, and verify they persist. Start a 4-player game and verify the count matches.</manual>
    <sampling_rate>After task completion</sampling_rate>
  </verify>
  <done>Table setup and preferences persist across sessions.</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: Leave Game and Forfeit Logic</name>
  <files>src/components/poker/GameController.tsx, src/components/poker/ActionBar.tsx</files>
  <action>
    - Add a "Leave Game" button to the top-right menu or action bar.
    - Implement a confirmation modal: "Leave current hand? This will forfeit the hand."
    - On confirmation, set hand result to "Forfeited", save to history in Dexie, and route back to the Lobby.
  </action>
  <verify>
    <manual>Start a hand, click Leave Game, confirm, verify you are in Lobby, and check History for a "Forfeited" entry.</manual>
    <sampling_rate>After task completion</sampling_rate>
  </verify>
  <done>User can cleanly exit hands with history tracking.</done>
</task>

</tasks>

<verification>
Verify that choosing 6 players in the Lobby actually starts a 6-player game. Verify that toggling "Show Insights" mid-hand works without the cards changing or pot resetting.
</verification>

<success_criteria>
- Lobby configuration correctly initializes the game engine.
- Settings are persistent across browser refreshes.
- Leave Game functionality works as expected with history persistence.
</success_criteria>

<output>
After completion, create `.planning/phases/05-expansion-future/05-04-SUMMARY.md`
</output>
